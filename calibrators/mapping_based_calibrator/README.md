# mapping_based_calibrator

A tutorial for this calibrator can be found [here](../docs/tutorials/mapping_based_calibrator.md)

## Purpose

The package `mapping_based_calibrator` allows extrinsic calibration between 3d lidar and 3d lidar sensors, as well as baselink and 3d lidar sensors used in autonomous driving and robotics.

## Inner-workings / Algorithms

### lidar-lidar calibration

The calibrator is designed to estimate the transformation between lidar and lidar sensors. It starts by employing a lidar, called the `mapping lidar`, for mapping purposes. It utilizes pointcloud registration algorithms to calibrate the remaining lidars, known as `calibration lidars`, to the `mapping lidar`. Specifically, the calibration process encompasses three primary steps: constructing a map, preparing calibration data, and finally estimating the transformations.

A prerequisite for this calibrator is an environment rich in natural landmarks suitable for registration-based mapping in all directions, ensuring that the lidar captures sufficient details beyond simple features like lane surfaces or walls.

#### Step 1: Construct a map

The calibrator designates one of the lidars (defined in the launch file) as the `mapping lidar` for mapping purposes. Pointclouds from this lidar utilize either the NDT or GICP algorithm to calculate the pose and also store the pointclouds as a map for future usage. The following rules are applied while constructing the map.

- For each `N` meter, a keyframe will be saved, which is used for mapping and estimating transformation.
- If the distance between the last frame and the current pointcloud is more than the `D` meters, the pointcloud will be saved as a frame, which is used to complement keyframes.

#### Step 2: Prepare calibration data

After the mapping has been completed, some preprocessing is necessary before estimating the transformations between lidars. In the explanation below, we assume that there is only a `calibration lidar` that needs to be calibrated with the `mapping lidar`.

##### Data synchronization

As the tool aims to apply registration algorithms on the pointclouds from both the `mapping lidar` and the `calibration lidar` to estimate the transformation between them, it's crucial to ensure those pointclouds share the same timestamp. However, the `calibration lidar` may not be synchronized with the `mapping lidar`, meaning these pointclouds cannot be directly used together during movement. To address this, the tool first needs to interpolate the pose of the `mapping lidar` at the timestamp of the `calibration lidar` in the map.

##### Data selection

To refine our calibration process, the tool first pairs `mapping lidar` keyframes with their closest `calibration lidar` frames, and then selects pairs (`mapping lidar` keyframes and `calibration lidar` frame) based on the criteria listed below.

- The pairs have Low time difference and low interpolation error (such as time difference, speed, and estimated acceleration) between the keyframe and the `calibration lidar` frame.
- The `calibration lidar` frame has enough features for calibration, which we filter out the pointcloud that has low variance in the z-axis that is mostly a plane.

##### Data preprocessing

For the `calibration lidar` pointcloud to have more points to apply the registration algorithm, the calibrator would need a high-resolution pointcloud from the `mapping lidar`. Therefore, we augment the keyframe's pointcloud with all the frames' pointcloud near it. As the resulting pointcloud has redundant information, we downsample the pointcloud to quite a fine-grained resolution, which is called augmented pointcloud.

#### Step 3: Estimate transformations

Once the data is prepared for calibration, the tool applies registration algorithms, such as NDT and GICP, to estimate the transformation between pointcloud from the `calibration lidar` and the augmented pointcloud from the `mapping lidar`.

### base-lidar calibration

Instead of calibrating the transformations between lidars, we can also utilize the map generated by the `mapping lidar` to calibrate the transformation between the `mapping lidar` and the `base_link`.

#### Step 1: Mapping

The first step of base-lidar calibration would be the same as [Step 1](#step-1-mapping) in `lidar-lidar calibration`.

#### Step 2: Extract ground from the pointcloud

After constructing the map, we could get the augmented pointcloud from `mapping lidar`, which would be the same process as [Step 2](#step-2-prepare-calibration-data). Afterward, the tool utilizes PCA and a segmentation algorithm for extracting the ground plane from the augmented pointcloud.

#### Step 3: Estimate transformation

To estimate the transformation between the `mapping lidar` and the `baselink`, the tool needs to calculate the transformation between the lidar and the ground pose, as well as the transformation between the ground pose and the baselink.

The transformation between the lidar and the ground pose is calculated by utilizing the normal vector of the plane and selecting a point on the ground plane. To estimate the transformation between the ground pose and the baselink, the tool first determines the initial ground-pose-to-baselink using the initial lidar-to-baselink and lidar-to-ground-pose transformations. Then, the tool projects this initial ground-pose-to-baselink transformation onto the xy plane to estimate the transformation between the ground pose and the baselink.

## ROS Interfaces

### Input

| Name                             | Type                                              | Description                                                                                                                         |
| -------------------------------- | ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| `calibration_camera_info_topics` | `sensor_msgs::msg::CameraInfo`                    | Intrinsic parameters of the calibration cameras. `calibration_camera_info_topics` is provided via parameters (currently not used).  |
| `calibration_image_topics`       | `sensor_msgs::msg::CompressedImage`               | Calibration cameras' image topics. `calibration_image_topics` is provided via parameters (currently not used).                      |
| `mapping_pointcloud`             | `sensor_msgs::msg::PointCloud2`                   | Pointcloud's topic used for mapping processes. It is recommended to select the lidar that has the highest resolution.               |
| `calibration_pointcloud_topics`  | `sensor_msgs::msg::PointCloud2`                   | Pointclouds' topics used for calibrating with the `mapping pointcloud`. `calibration_pointcloud_topics` is provided via parameters. |
| `detected_objects`               | `autoware_perception_msgs::msg::DetectedObjects`  | Messages containing detected objects, used in the filtering procedure.                                                              |
| `predicted_objects`              | `autoware_perception_msgs::msg::PredictedObjects` | Messages that contain predicted object paths and positions, used in the filtering procedure.                                        |

### Output

| Name                              | Type                                   | Description                                                                                                                                     |
| --------------------------------- | -------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| `output_map`                      | `sensor_msgs::msg::PointCloud2`        | Output map constructed from the `mapping_pointcloud`, providing visualization in rviz.                                                          |
| `frame_path`                      | `nav_msgs::msg::Path`                  | Actual path of `mapping_pointcloud`, providing visualization in rviz.                                                                           |
| `frame_predicted_path`            | `nav_msgs::msg::Path`                  | Predicted path of `mapping_pointcloud`, providing visualization in rviz.                                                                        |
| `keyframe_path`                   | `nav_msgs::msg::Path`                  | Keyframe path of `mapping_pointcloud`, providing visualization in rviz.                                                                         |
| `keyframe_markers`                | `visualization_msgs::msg::MarkerArray` | Markers for keyframes, providing visualization in rviz.                                                                                         |
| `initial_source_aligned_map`      | `sensor_msgs::msg::PointCloud2`        | Initial map from calibration lidars, providing visualization in rviz.                                                                           |
| `calibrated_source_aligned_map`   | `sensor_msgs::msg::PointCloud2`        | Calibrated map from calibration lidars, providing visualization in rviz.                                                                        |
| `target_map`                      | `sensor_msgs::msg::PointCloud2`        | Target map from `mapping lidar`, used for comparing with the `calibrated_source_aligned_map` and `target_map`, providing visualization in rviz. |
| `target_markers`                  | `visualization_msgs::msg::MarkerArray` | Markers for camera calibrator (currently not used)                                                                                              |
| `base_lidar_augmented_pointcloud` | `sensor_msgs::msg::PointCloud2`        | Ground pointcloud from augmented pointcloud.                                                                                                    |
| `ground_pointcloud`               | `sensor_msgs::msg::PointCloud2`        | Ground pointcloud from calibrated pointcloud.                                                                                                   |

### Services

| Name                    | Type                                                  | Description                                                                              |
| ----------------------- | ----------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| `extrinsic_calibration` | `tier4_calibration_msgs::` `srv::ExtrinsicCalibrator` | Generic calibration service. The call is blocked until the calibration process finishes. |
| `stop_mapping`          | `std_srvs::srv::Empty`                                | Stops building the map; calibration will begin afterward.                                |
| `load_database`         | `std_srvs::srv::Empty`                                | Loads lidar and camera calibration frames from the database. (currently not used)        |
| `save_database`         | `std_srvs::srv::Empty`                                | Saves lidar and camera calibration frames to the database. (currently not used)          |

## Parameters

### Core Parameters

| Name                                     | Type                  | Default Value | Description                                                                                                                                                                                   |
| ---------------------------------------- | --------------------- | ------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `calibrate_base_frame`                   | `bool`                | `false`       | Flag to optionally calibrate the base frame. (base_link).                                                                                                                                     |
| `base_frame`                             | `std::string`         |               | Frame name of the base frame used in base-lidar calibration.                                                                                                                                  |
| `map_frame`                              | `std::string`         |               | Frame name of the `map`.                                                                                                                                                                      |
| `calibration_camera_optical_link_frames` | `std::vector<string>` |               | List of frame names for `calibration camera` . (currently not used)                                                                                                                           |
| `calibration_lidar_frames`               | `std::vector<string>` |               | List of frame names for `calibration lidars`.                                                                                                                                                 |
| `calibration_camera_info_topics`         | `std::vector<string>` |               | List of camera info topics for `calibration camera`. (currently not used)                                                                                                                     |
| `calibration_image_topics`               | `std::vector<string>` |               | List of camera image topics for `calibration camera`. (currently not used)                                                                                                                    |
| `calibration_pointcloud_topics`          | `std::vector<string>` |               | List of pointcloud topics for `calibration lidars`.                                                                                                                                           |
| `mapping_lidar_frame`                    | `std::string`         |               | Frame name of the `mapping_lidar`.                                                                                                                                                            |
| `mapping_registrator`                    | `std::string`         |               | Name of the PCL registration algorithm used for mapping processes (NDT/GICP).                                                                                                                 |
| `mapping_verbose`                        | `bool`                | `false`       | Verbose output flag for mapping processes.                                                                                                                                                    |
| `use_rosbag`                             | `bool`                | `true`        | Flag to determine if data should be read from a rosbag file.                                                                                                                                  |
| `mapping_max_frames`                     | `int`                 | `500`         | Maximum number of frames to use for mapping, if the number of frames is larger than this value, the mapper stops and the calibration starts.                                                  |
| `local_map_num_keyframes`                | `int`                 | `15`          | Number of keyframes in the local map.                                                                                                                                                         |
| `dense_pointcloud_num_keyframes`         | `int`                 | `10`          | Dense pointcloud for calibration is generated by integrating the pointcloud in the range of [keyframe_id - `dense_pointcloud_num_keyframes`, keyframe_id + `dense_pointcloud_num_keyframes`]. |
| `mapping_min_range`                      | `double`              | `0.5`         | Minimum range in meters of each lidar pointcloud for mapping.                                                                                                                                 |
| `mapping_max_range`                      | `double`              | `60.0`        | Maximum range in meters of each lidar pointcloud for mapping.                                                                                                                                 |
| `min_mapping_pointcloud_size`            | `int`                 | `10000`       | Minimum size of pointcloud required for mapping.                                                                                                                                              |
| `min_calibration_pointcloud_size`        | `int`                 | `500`         | Minimum size of pointcloud that is necessary for estimating transformation.                                                                                                                   |
| `mapping_lost_timeout`                   | `double`              | `1.0`         | Sensor's timeout in seconds to consider the mapping process is failed.                                                                                                                        |

### Mapping Parameters

| Name                                 | Type     | Default Value | Description                                                                                                                    |
| ------------------------------------ | -------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| `mapper_resolution`                  | `double` | `5.0`         | Resolution for `pclomp::NormalDistributionsTransform` algorithm.                                                               |
| `mapper_step_size`                   | `double` | `0.1`         | Step size for `pclomp::NormalDistributionsTransform` algorithm.                                                                |
| `mapper_max_iterations`              | `int`    | `35`          | Maximum number of iterations for `pclomp::NormalDistributionsTransform` and `pcl::GeneralizedIterativeClosestPoint` algorithm. |
| `mapper_epsilon`                     | `double` | `0.01`        | Epsilon value for `pclomp::NormalDistributionsTransform` and `pcl::GeneralizedIterativeClosestPoint` algorithm.                |
| `mapper_num_threads`                 | `int`    | `8`           | Number of threads to use for `pclomp::NormalDistributionsTransform` algorithm.                                                 |
| `mapper_max_correspondence_distance` | `double` | `0.1`         | Maximum correspondence distance for `pcl::GeneralizedIterativeClosestPoint` algorithm.                                         |
| `mapping_viz_leaf_size`              | `double` | `0.15`        | Leaf size in meters for `pcl::VoxelGrid` to voxelize the mapping pointcloud.                                                   |
| `calibration_viz_leaf_size`          | `double` | `0.15`        | Leaf size in meters for `pcl::VoxelGridTriplets` to voxelize the calibration pointcloud.                                       |
| `leaf_size_input`                    | `double` | `0.1`         | Leaf size in meters for `pcl::VoxelGrid` to voxelize the input pointcloud.                                                     |
| `leaf_size_local_map`                | `double` | `0.1`         | Leaf size in meters for `pcl::VoxelGrid` to voxelize the local map.                                                            |
| `leaf_size_dense_map`                | `double` | `0.05`        | Leaf size in meters for `pcl::VoxelGrid` to voxelize the dense map.                                                            |
| `new_keyframe_min_distance`          | `double` | `1.0`         | Minimum distance in meters between consecutive keyframes.                                                                      |
| `new_frame_min_distance`             | `double` | `0.05`        | Minimum distance in meters of a new frame needs to be apart from the last to be processed.                                     |
| `frame_stopped_distance`             | `double` | `0.02`        | Threshold distance in meters to determine if the frame has stopped moving.                                                     |
| `frames_since_stoped_force_frame`    | `int`    | `5`           | If the number of stopped frames is equal to this value, we set it as keyframe_and_stop frame.                                  |
| `calibration_skip_keyframes`         | `int`    | `5`           | The number of initial keyframes that are skipped for calibration.                                                              |

### Calibration Criteria Parameters

| Name                                         | Type     | Default Value | Description                                                                                                                                   |
| -------------------------------------------- | -------- | ------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| `max_allowed_interpolated_time`              | `double` | `0.05`        | Maximum allowable time in seconds for frame interpolated time in standard criteria.                                                           |
| `max_allowed_interpolated_distance`          | `double` | `0.05`        | Maximum allowable distance in meters for frame interpolated distance in standard criteria.                                                    |
| `max_allowed_interpolated_angle`             | `double` | `1.0`         | Maximum allowable angle in degrees for frame interpolated angle in standard criteria.                                                         |
| `max_allowed_interpolated_speed`             | `double` | `3.0`         | Maximum allowable speed in meter/second for frame interpolated speed in standard criteria.                                                    |
| `max_allowed_interpolated_accel`             | `double` | `0.4`         | Maximum allowable acceleration in meter/second^2 for frame interpolated acceleration in standard criteria.                                    |
| `max_allowed_interpolated_distance_straight` | `double` | `0.08`        | Maximum allowable distance in meters for frame interpolated distance in straight criteria.                                                    |
| `max_allowed_interpolated_angle_straight`    | `double` | `0.5`         | Maximum allowable angle in degrees for frame interpolated angle in straight criteria.                                                         |
| `max_allowed_interpolated_speed_straight`    | `double` | `5.0`         | Maximum allowable speed in meters for frame interpolated speed in straight criteria.                                                          |
| `max_allowed_interpolated_accel_straight`    | `double` | `0.1`         | Maximum allowable acceleration in meter/second^2 for frame interpolated acceleration in straight criteria.                                    |
| `filter_detections`                          | `bool`   | `true`        | Flag to enable filtering of detection to improve calibration accuracy and reduce noise.                                                       |
| `detection_max_time_tolerance`               | `double` | `0.5`         | Maximum time tolerance in seconds for obtaining all detections close in time to the source pointcloud.                                        |
| `detection_size_tolerance`                   | `double` | `0.4`         | Tolerance for detection size in meters to account for measurement errors and environmental factors.                                           |
| `lost_frame_max_angle_diff`                  | `double` | `25.0`        | Maximum allowable angular difference in degrees between keyframes to consider a frame as lost, used in handling outliers in frame processing. |
| `lost_frame_interpolation_error`             | `double` | `0.05`        | Maximum allowable interpolation error in meters between keyframes to consider a frame as lost, used in handling outliers in frame processing. |
| `lost_frame_max_acceleration`                | `double` | `8.0`         | Maximum allowable acceleration in meter/second between keyframes to consider a frame as lost, used in handling outliers in frame processing.  |
| `viz_max_range`                              | `double` | `80.0`        | Maximum range in meters for visualization purposes, setting the boundary for displayable data.                                                |
| `crop_z_calibration_pointclouds`             | `bool`   | `true`        | Flag to enable cropping of the Z-axis in calibration pointclouds.                                                                             |
| `crop_z_calibration_pointclouds_value`       | `double` | `2.0`         | Value of cropping the Z-axis in the calibration pointcloud.                                                                                   |
| `calibration_use_only_stopped`               | `bool`   | `false`       | Flag to use only data from stopped frames.                                                                                                    |
| `calibration_use_only_last_frames`           | `bool`   | `false`       | Consider only the last frames for calibration.                                                                                                |
| `max_calibration_range`                      | `double` | `80.0`        | Maximum range in meters to consider for calibration purposes, defining the spatial boundary for calibration data.                             |
| `min_calibration_range`                      | `double` | `1.5`         | Minimum range in meters to consider for calibration purposes, defining the spatial boundary for calibration data.                             |
| `calibration_min_pca_eigenvalue`             | `double` | `0.25`        | If the eigenvalue of a pointcloud is less than this value, it will be filtered out.                                                           |
| `calibration_min_distance_between_frames`    | `double` | `5.0`         | Threshold for the minimum distance in meters between frames.                                                                                  |
| `calibration_eval_max_corr_distance`         | `double` | `0.1`         | Maximum correspondence distance in meters for source pointcloud and target pointcloud.                                                        |

### Calibration Parameters

| Name                       | Type     | Default Value | Description                                                                                                              |
| -------------------------- | -------- | ------------- | ------------------------------------------------------------------------------------------------------------------------ |
| `solver_iterations`        | `int`    | `200`         | Number of iterations for the PCL registration algorithm during calibration, affecting the convergence rate and accuracy. |
| `max_corr_dist_coarse`     | `double` | `0.5`         | Maximum coarse correspondence distance for the PCL registration algorithm during calibration.                            |
| `max_corr_dist_fine`       | `double` | `0.1`         | Maximum fine correspondence distance for the PCL registration algorithm during calibration.                              |
| `max_corr_dist_ultra_fine` | `double` | `0.05`        | Maximum ultra fine correspondence distance for the PCL registration algorithm during calibration.                        |

### Lidar Calibration Parameters

| Name                           | Type  | Default Value | Description                                                       |
| ------------------------------ | ----- | ------------- | ----------------------------------------------------------------- |
| `lidar_calibration_min_frames` | `int` | `2`           | Minimum number of calibration frames to use in lidar calibration. |
| `lidar_calibration_max_frames` | `int` | `10`          | Maximum number of calibration frames to use in lidar calibration. |

### Camera Calibration Parameters (currently not used)

| Name                            | Type     | Default Value | Description                                                  |
| ------------------------------- | -------- | ------------- | ------------------------------------------------------------ |
| `camera_calibration_min_frames` | `int`    | `1`           | Minimum number of frames to consider for camera calibration. |
| `camera_calibration_max_frames` | `int`    | `10`          | Maximum number of frames to use in camera calibration.       |
| `pc_features_min_distance`      | `double` | `0.2`         | Near plane distance in meters for `pcl::FrustumCulling`.     |
| `pc_features_max_distance`      | `double` | `40.0`        | Far plane distance in meters for `pcl::FrustumCulling`.      |

### Base-Lidar Calibration Parameters

| Name                                     | Type     | Default Value | Description                                                                                                    |
| ---------------------------------------- | -------- | ------------- | -------------------------------------------------------------------------------------------------------------- |
| `base_lidar_crop_box_min_x`              | `double` | `-20.0`       | Minimum X-coordinate in meters for the cropping box in base-lidar calibration to focus on relevant data areas. |
| `base_lidar_crop_box_min_y`              | `double` | `-20.0`       | Minimum Y-coordinate in meters for the cropping box in base-lidar calibration to focus on relevant data areas. |
| `base_lidar_crop_box_min_z`              | `double` | `-20.0`       | Minimum Z-coordinate in meters for the cropping box in base-lidar calibration to focus on relevant data areas. |
| `base_lidar_crop_box_max_x`              | `double` | `20.0`        | Maximum X-coordinate in meters for the cropping box in base-lidar calibration to focus on relevant data areas. |
| `base_lidar_crop_box_max_y`              | `double` | `20.0`        | Maximum Y-coordinate in meters for the cropping box in base-lidar calibration to focus on relevant data areas. |
| `base_lidar_crop_box_max_z`              | `double` | `20.0`        | Maximum Z-coordinate in meters for the cropping box in base-lidar calibration to focus on relevant data areas. |
| `base_lidar_max_inlier_distance`         | `double` | `0.01`        | Maximum inlier distance in meters for ground extraction by using `pcl::SACSegmentation`.                       |
| `base_lidar_max_iterations`              | `int`    | `1000`        | Maximum number of iterations for ground extraction by using `pcl::SACSegmentation`.                            |
| `base_lidar_min_plane_points`            | `int`    | `1000`        | Minimum number of points required in a pointcloud, ensuring sufficient data for applying ground extraction.    |
| `base_lidar_min_plane_points_percentage` | `double` | `10.0`        | Minimum percentage of ground plane points in a pointcloud.                                                     |
| `base_lidar_max_cos_distance`            | `double` | `0.5`         | Maximum cosine distance for applying ground plane extraction.                                                  |
| `base_lidar_overwrite_xy_yaw`            | `bool`   | `false`       | Flag to allow overwriting the x, y, and yaw value during base-lidar calibration.                               |

## Known issues/limitations

- As described in [Step 2](#step-2-prepare-calibration-data), the calibrator interpolates the pose of the `mapping lidar` at the timestamp of the `calibration lidars`. Therefore, the calibrator highly requires time synchronization between all of the lidar sensors.
- It is required that the `mapping lidar` have high resolution. For the `calibration lidar`, both high and low resolutions are acceptable. Therefore, the vehicle with only low-resolution lidars couldn't use the calibrator.
- A good initial calibration parameters is required for the calibrator. Better initial calibration parameters could help the registration algorithm estimate a more reliable transformation.

## Pro tips/recommendations

- To build the map accurately, drive your vehicle at the lowest feasible speed, for example, 2 km/h would be a good speed. If the user drives the vehicle too fast, the pointcloud will be distorted.
- To create an accurate map, the surroundings of the calibration area are crucial. Ensure that the environment is rich in natural landmarks suitable for registration-based mapping in all directions, which is shown in the image below. This will help the lidar capture sufficient details beyond simple features like lane surfaces or walls.

<p align="center">
    <img src="../docs/images/mapping_based_calibrator/mapping_based_vis.svg" alt="radar_reflector" width="900">
<p align="center">
